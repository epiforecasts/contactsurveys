name: API health check

on:
  schedule:
    # Run monthly on the 1st at 04:00 UTC
    - cron: '0 4 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  api-health-check:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v6

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::devtools, any::testthat, any::vcr

      - name: Test against live API
        run: |
          Rscript -e '
            devtools::load_all()

            # Run key tests without vcr to verify live API compatibility
            # These hit the real Zenodo API - if they pass, the API is still compatible

            # Test list_surveys works
            surveys <- list_surveys(verbose = FALSE)
            stopifnot(
              inherits(surveys, "data.frame"),
              nrow(surveys) > 0,
              "title" %in% names(surveys),
              "creator" %in% names(surveys)
            )
            message("✓ list_surveys() works")

            # Test get_citation works with a known DOI
            cite <- get_citation("10.5281/zenodo.1127693")
            stopifnot(inherits(cite, "csbib"))
            message("✓ get_citation() works")

            # Test download_survey works (just metadata, not full download)
            survey_info <- list_surveys(verbose = FALSE)
            stopifnot(nrow(survey_info) > 0)
            message("✓ API health check passed")
          '
